<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MPS ì„œë¹„ìŠ¤ í…ŒìŠ¤íŠ¸</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .container {
            background: white;
            padding: 2rem;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 500px;
        }

        .header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .header h1 {
            color: #333;
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .header p {
            color: #666;
            font-size: 0.9rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            color: #333;
            font-weight: 600;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .form-group input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .action-section {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-top: 2rem;
        }

        .action-button {
            flex: 1;
            padding: 0.75rem 1.5rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .action-button:hover {
            transform: translateY(-2px);
        }

        .action-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .speaker-container {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 60px;
            height: 60px;
            background: #f8f9fa;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .speaker-icon {
            font-size: 2rem;
            color: #ccc;
            transition: all 0.3s ease;
        }

        .speaker-container.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .speaker-container.active .speaker-icon {
            color: white;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .status-message {
            margin-top: 1rem;
            padding: 0.75rem;
            border-radius: 8px;
            font-size: 0.9rem;
            text-align: center;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-info {
            background: #cce7ff;
            color: #004085;
            border: 1px solid #b3d7ff;
        }

        .hidden {
            display: none;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .audio-controls {
            margin-top: 1rem;
            text-align: center;
        }

        .quick-buttons {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .quick-button {
            padding: 0.4rem 0.8rem;
            background: #f8f9fa;
            color: #495057;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .quick-button:hover {
            background: #e9ecef;
        }

        .logs {
            margin-top: 1.5rem;
            max-height: 200px;
            overflow-y: auto;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1rem;
        }

        .log-entry {
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            margin-bottom: 0.5rem;
            padding: 0.3rem;
            border-radius: 4px;
        }

        .log-request {
            background: #e3f2fd;
            color: #1565c0;
        }

        .log-response {
            background: #e8f5e8;
            color: #2e7d32;
        }

        .log-error {
            background: #ffebee;
            color: #c62828;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸµ MPS í…ŒìŠ¤íŠ¸</h1>
            <p>ìŒì› ì¬ìƒ ë° ê°€ì‚¬ ë‹¤ìš´ë¡œë“œ í…ŒìŠ¤íŠ¸</p>
        </div>

        <div class="form-group">
            <label for="endpoint">API ì—”ë“œí¬ì¸íŠ¸</label>
            <input 
                type="text" 
                id="endpoint" 
                placeholder="ì˜ˆ: api/music/1/play ë˜ëŠ” api/lyric/1/download"
                value="api/music/1/play"
            >
        </div>

        <div class="form-group">
            <label for="apiKey">API Key</label>
            <input 
                type="text" 
                id="apiKey" 
                placeholder="ì—¬ê¸°ì— API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                value="free_test_api_key_64_characters_long_string_for_testing_purpose"
            >
        </div>

        <div class="form-group">
            <label for="serverUrl">ì„œë²„ URL</label>
            <input 
                type="text" 
                id="serverUrl" 
                placeholder="ë°±ì—”ë“œ ì„œë²„ URL"
                value="http://localhost:3001"
            >
        </div>

        <div class="quick-buttons">
            <button class="quick-button" onclick="setQuickTest('api/music/1/play', 'free')">Free - ìŒì›1 ì¬ìƒ</button>
            <button class="quick-button" onclick="setQuickTest('api/music/2/play', 'standard')">Standard - ìŒì›2 ì¬ìƒ</button>
            <button class="quick-button" onclick="setQuickTest('api/music/3/play', 'business')">Business - ìŒì›3 ì¬ìƒ</button>
            <button class="quick-button" onclick="setQuickTest('api/lyric/1/download', 'free')">Free - ê°€ì‚¬1 ë‹¤ìš´ë¡œë“œ</button>
            <button class="quick-button" onclick="setQuickTest('api/lyric/2/download', 'standard')">Standard - ê°€ì‚¬2 ë‹¤ìš´ë¡œë“œ</button>
        </div>

        <div class="action-section">
            <button class="action-button" id="actionButton">
                <span id="buttonText">ì¬ìƒ</span>
                <span class="loading hidden" id="loadingSpinner"></span>
            </button>
            <div class="speaker-container" id="speakerContainer">
                <div class="speaker-icon">ğŸ”Š</div>
            </div>
        </div>

        <div class="status-message hidden" id="statusMessage"></div>
        
        <div class="audio-controls hidden" id="audioControls">
            <audio controls id="audioPlayer" preload="metadata">
                <source src="" type="audio/mpeg">
                Your browser does not support the audio element.
            </audio>
        </div>

        <div class="logs hidden" id="logsContainer">
            <div style="font-weight: bold; margin-bottom: 0.5rem;">ìš”ì²­/ì‘ë‹µ ë¡œê·¸:</div>
            <div id="logsContent"></div>
        </div>
    </div>

    <script>
        const endpointInput = document.getElementById('endpoint');
        const apiKeyInput = document.getElementById('apiKey');
        const serverUrlInput = document.getElementById('serverUrl');
        const actionButton = document.getElementById('actionButton');
        const buttonText = document.getElementById('buttonText');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const speakerContainer = document.getElementById('speakerContainer');
        const statusMessage = document.getElementById('statusMessage');
        const audioControls = document.getElementById('audioControls');
        const audioPlayer = document.getElementById('audioPlayer');
        const logsContainer = document.getElementById('logsContainer');
        const logsContent = document.getElementById('logsContent');

        // ì¬ìƒ ì„¸ì…˜ ì¶”ì  ë³€ìˆ˜ (í‘œì‹œìš©)
        let currentSessionId = null;
        let currentMusicId = null;
        let playStartTime = null;
        let totalPlayTime = 0;

        // API í‚¤ ë§¤í•‘
        const API_KEYS = {
            'free': 'free_test_api_key_64_characters_long_string_for_testing_purpose',
            'standard': 'standard_test_api_key_64_characters_long_string_for_testing',
            'business': 'business_test_api_key_64_characters_long_string_for_testing'
        };

        // ì¬ìƒ ì‹œê°„ í‘œì‹œìš© í•¨ìˆ˜ë“¤ (ì„œë²„ì—ì„œ ìë™ ì²˜ë¦¬ë˜ë¯€ë¡œ í‘œì‹œìš©ìœ¼ë¡œë§Œ ì‚¬ìš©)
        function startPlayTimeTracking() {
            if (!playStartTime) {
                playStartTime = Date.now();
                addLog('í´ë¼ì´ì–¸íŠ¸ ì¬ìƒ ì‹œê°„ í‘œì‹œ ì‹œì‘ (ì„œë²„ì—ì„œ ìë™ ì¶”ì )', 'response');
            }
        }
        
        function pausePlayTimeTracking() {
            if (playStartTime) {
                totalPlayTime += Math.floor((Date.now() - playStartTime) / 1000);
                playStartTime = null;
                addLog(`í´ë¼ì´ì–¸íŠ¸ í‘œì‹œ - ì´ ì¬ìƒì‹œê°„: ${totalPlayTime}ì´ˆ (ì°¸ê³ ìš©)`, 'response');
            }
        }
        
        function stopPlayTimeTracking() {
            if (playStartTime) {
                totalPlayTime += Math.floor((Date.now() - playStartTime) / 1000);
                playStartTime = null;
            }
            const finalPlayTime = totalPlayTime;
            totalPlayTime = 0;
            addLog(`í´ë¼ì´ì–¸íŠ¸ í‘œì‹œ - ìµœì¢… ì¬ìƒì‹œê°„: ${finalPlayTime}ì´ˆ (ì°¸ê³ ìš©)`, 'response');
            return finalPlayTime;
        }
        
        
        function setQuickTest(endpoint, grade) {
            endpointInput.value = endpoint;
            apiKeyInput.value = API_KEYS[grade];
            updateButtonText();
            addLog(`í€µ í…ŒìŠ¤íŠ¸ ì„¤ì •: ${grade} ë“±ê¸‰ìœ¼ë¡œ ${endpoint}`, 'request');
        }

        // ë¡œê·¸ ì¶”ê°€
        function addLog(message, type) {
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logsContent.appendChild(logEntry);
            logsContainer.classList.remove('hidden');
            logsContent.scrollTop = logsContent.scrollHeight;
        }

        // ì—”ë“œí¬ì¸íŠ¸ ë³€ê²½ ê°ì§€ ë° ë²„íŠ¼ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
        endpointInput.addEventListener('input', updateButtonText);

        function updateButtonText() {
            const endpoint = endpointInput.value.trim();
            if (endpoint.includes('/music/') && endpoint.includes('/play')) {
                buttonText.textContent = 'ì¬ìƒ';
            } else if (endpoint.includes('/lyric/download')) {
                buttonText.textContent = 'ê°€ì‚¬ ë‹¤ìš´ë¡œë“œ';
            } else {
                buttonText.textContent = 'ìš”ì²­';
            }
        }

        function showStatus(message, type) {
            statusMessage.textContent = message;
            statusMessage.className = `status-message status-${type}`;
            statusMessage.classList.remove('hidden');
        }

        function hideStatus() {
            statusMessage.classList.add('hidden');
        }

        function setLoading(loading) {
            if (loading) {
                buttonText.classList.add('hidden');
                loadingSpinner.classList.remove('hidden');
                actionButton.disabled = true;
            } else {
                buttonText.classList.remove('hidden');
                loadingSpinner.classList.add('hidden');
                actionButton.disabled = false;
            }
        }

        function activateSpeaker() {
            speakerContainer.classList.add('active');
        }

        function deactivateSpeaker() {
            speakerContainer.classList.remove('active');
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }

        // ì‹¤ì œ API í˜¸ì¶œ í•¨ìˆ˜
        async function makeActualRequest(endpoint, apiKey, serverUrl) {
            const fullUrl = `${serverUrl}/${endpoint}`;
            
            addLog(`ìš”ì²­: ${fullUrl}`, 'request');
            addLog(`API Key: ${apiKey.substring(0, 20)}...`, 'request');

            try {
                const response = await fetch(fullUrl, {
                    method: 'GET',
                    headers: {
                        'x-api-key': apiKey,
                        'User-Agent': 'MPS-Test-Client/1.0'
                    }
                });

                addLog(`ì‘ë‹µ: ${response.status} ${response.statusText}`, 'response');

                // ìŒì› ì¬ìƒ ì‘ë‹µì—ì„œ ì„¸ì…˜ ID ì¶”ì¶œ
                if (endpoint.includes('/music/') && endpoint.includes('/play')) {
                    const sessionId = response.headers.get('X-Session-ID');
                    if (sessionId) {
                        addLog(`ì„¸ì…˜ ID ìˆ˜ì‹ : ${sessionId}`, 'response');
                        return { response, sessionId: parseInt(sessionId) };
                    }
                }

                if (!response.ok) {
                    let errorMessage = `HTTP ${response.status}: ${response.statusText}`;
                    try {
                        const errorText = await response.text();
                        if (errorText) {
                            const errorData = JSON.parse(errorText);
                            errorMessage = errorData.message || errorMessage;
                        }
                    } catch (e) {
                        // JSON íŒŒì‹± ì‹¤íŒ¨ì‹œ ê¸°ë³¸ ì—ëŸ¬ ë©”ì‹œì§€ ì‚¬ìš©
                    }
                    throw new Error(errorMessage);
                }

                return { response };
            } catch (error) {
                addLog(`ì˜¤ë¥˜: ${error.message}`, 'error');
                throw error;
            }
        }

        async function makeRequest() {
            const endpoint = endpointInput.value.trim();
            const apiKey = apiKeyInput.value.trim();
            const serverUrl = serverUrlInput.value.trim();

            if (!endpoint || !apiKey || !serverUrl) {
                showStatus('ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            setLoading(true);
            hideStatus();
            deactivateSpeaker();
            audioControls.classList.add('hidden');

            try {
                if (endpoint.includes('/music/') && endpoint.includes('/play')) {
                    // ìŒì› ì¬ìƒ ì²˜ë¦¬
                    const musicId = endpoint.match(/music\/(\d+)\/play/)?.[1];
                    if (!musicId) {
                        throw new Error('ì˜ëª»ëœ ìŒì› ì—”ë“œí¬ì¸íŠ¸ í˜•ì‹ì…ë‹ˆë‹¤.');
                    }

                    addLog(`ìŒì› ${musicId}ë²ˆ ì¬ìƒ ìš”ì²­ ì‹œì‘`, 'request');
                    
                    const result = await makeActualRequest(endpoint, apiKey, serverUrl);
                    const response = result.response;
                    const sessionId = result.sessionId;
                    
                    // ì„¸ì…˜ ì •ë³´ ì €ì¥
                    currentSessionId = sessionId;
                    currentMusicId = parseInt(musicId);
                    
                    if (sessionId) {
                        addLog(`ì¬ìƒ ì„¸ì…˜ ì‹œì‘: ${sessionId}`, 'response');
                    }
                    
                    // ìŒì› ìŠ¤íŠ¸ë¦¬ë° ì²˜ë¦¬ (ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ë¡œ API í‚¤ ì „ë‹¬)
                    // ë¸Œë¼ìš°ì € ì˜¤ë””ì˜¤ ìš”ì†ŒëŠ” ì»¤ìŠ¤í…€ í—¤ë”ë¥¼ ë³´ë‚¼ ìˆ˜ ì—†ìœ¼ë¯€ë¡œ ì¿¼ë¦¬ íŒŒë¼ë¯¸í„° ì‚¬ìš©
                    const fullUrl = `${serverUrl}/${endpoint}?api_key=${encodeURIComponent(apiKey)}`;
                    
                    // Custom fetchë¡œ API í‚¤ í—¤ë”ë¥¼ í¬í•¨í•œ í”„ë¡ì‹œ URL ìƒì„±
                    // ì‹¤ì œ í™˜ê²½ì—ì„œëŠ” ì„œë²„ì—ì„œ ì¸ì¦ëœ ìŠ¤íŠ¸ë¦¬ë° URLì„ ì œê³µí•´ì•¼ í•¨
                    // ë¸Œë¼ìš°ì € ì˜¤ë””ì˜¤ ìš”ì†Œë¥¼ ìœ„í•´ ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ë¡œ API í‚¤ ì „ë‹¬
                    audioPlayer.src = fullUrl;
                    
                    // ë¸Œë¼ìš°ì €ì˜ Range ìš”ì²­ ê°ì§€ë¥¼ ìœ„í•œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
                    audioPlayer.addEventListener('loadstart', function() {
                        addLog('ë¸Œë¼ìš°ì €ê°€ Range ìš”ì²­ì„ ì‹œì‘í•©ë‹ˆë‹¤', 'response');
                        addLog('ì„œë²„ì—ì„œ ê° Range ìš”ì²­ë§ˆë‹¤ ì§„í–‰ë„ë¥¼ ìë™ ì¶”ì í•©ë‹ˆë‹¤', 'response');
                    });
                    
                    audioPlayer.addEventListener('progress', function() {
                        if (audioPlayer.buffered.length > 0) {
                            const buffered = audioPlayer.buffered.end(0);
                            const duration = audioPlayer.duration;
                            if (duration > 0) {
                                const progressPercent = Math.round((buffered / duration) * 100);
                                addLog(`ë²„í¼ë§ ì§„í–‰ë„: ${progressPercent}% (Range ìš”ì²­ ëˆ„ì )`, 'response');
                            }
                        }
                    });
                    
                    audioControls.classList.remove('hidden');
                    
                    showStatus(`ìŒì› ${musicId}ë²ˆ ìŠ¤íŠ¸ë¦¬ë° ì¤€ë¹„ ì¤‘...`, 'info');
                    addLog(`ìŒì› ë¡œë“œ ì™„ë£Œ - ìë™ ì¬ìƒ ì‹œì‘`, 'response');
                    
                    // ê¸°ì¡´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±° (ì¤‘ë³µ ë°©ì§€)
                    audioPlayer.onplay = null;
                    audioPlayer.onpause = null;
                    audioPlayer.onended = null;
                    audioPlayer.onerror = null;
                    audioPlayer.onloadeddata = null;
                    
                    // ì‹¤ì œ ì¬ìƒ ì‹œê°„ ì¶”ì ì„ ìœ„í•œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
                    audioPlayer.onplay = () => {
                        activateSpeaker();
                        showStatus(`ìŒì› ${musicId}ë²ˆ ì¬ìƒ ì¤‘... (ì„œë²„ì—ì„œ ìë™ ì¶”ì )`, 'info');
                        addLog(`â–¶ï¸ ìŒì› ${musicId}ë²ˆ ì¬ìƒ ì‹œì‘ - ì„œë²„ì—ì„œ ìœ íš¨ì¬ìƒ ìë™ íŒì •`, 'response');
                        startPlayTimeTracking();
                    };
                    
                    audioPlayer.onpause = () => {
                        deactivateSpeaker();
                        showStatus(`ìŒì› ${musicId}ë²ˆ ì¼ì‹œì •ì§€`, 'info');
                        addLog(`â¸ï¸ ìŒì› ${musicId}ë²ˆ ì¼ì‹œì •ì§€`, 'response');
                        pausePlayTimeTracking();
                    };
                    
                    audioPlayer.onended = () => {
                        deactivateSpeaker();
                        const finalPlayTime = stopPlayTimeTracking();
                        showStatus(`ìŒì› ${musicId}ë²ˆ ì¬ìƒ ì™„ë£Œ`, 'success');
                        addLog(`ğŸ ìŒì› ${musicId}ë²ˆ ì¬ìƒ ì™„ë£Œ - ì„œë²„ì—ì„œ ìë™ìœ¼ë¡œ ìœ íš¨ì¬ìƒ ì²˜ë¦¬`, 'response');
                        
                        currentSessionId = null;
                        currentMusicId = null;
                    };
                    
                    audioPlayer.onerror = (e) => {
                        console.error('ì˜¤ë””ì˜¤ ì¬ìƒ ì˜¤ë¥˜:', e);
                        deactivateSpeaker();
                        stopPlayTimeTracking();
                        showStatus('ì˜¤ë””ì˜¤ ì¬ìƒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                        addLog('âŒ ì˜¤ë””ì˜¤ ì¬ìƒ ì˜¤ë¥˜', 'error');
                        
                        currentSessionId = null;
                        currentMusicId = null;
                    };
                    
                    // ìŒì› ë°ì´í„° ë¡œë“œ ì™„ë£Œ ì‹œ ìë™ ì¬ìƒ
                    audioPlayer.onloadeddata = () => {
                        addLog(`ìŒì› ë°ì´í„° ë¡œë“œ ì™„ë£Œ - ìë™ ì¬ìƒ ì‹œì‘`, 'response');
                        audioPlayer.play().catch(error => {
                            console.error('ìë™ ì¬ìƒ ì‹¤íŒ¨:', error);
                            addLog(`ìë™ ì¬ìƒ ì‹¤íŒ¨: ${error.message}`, 'error');
                            showStatus('ìë™ ì¬ìƒì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. ìˆ˜ë™ìœ¼ë¡œ ì¬ìƒ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.', 'error');
                        });
                    };

                } else if (endpoint.includes('/lyric/') && endpoint.includes('/download')) {
                    // ê°€ì‚¬ ë‹¤ìš´ë¡œë“œ ì²˜ë¦¬
                    const musicId = endpoint.match(/lyric\/(\d+)\/download/)?.[1];
                    if (!musicId) {
                        throw new Error('ì˜ëª»ëœ ê°€ì‚¬ ì—”ë“œí¬ì¸íŠ¸ í˜•ì‹ì…ë‹ˆë‹¤.');
                    }

                    addLog(`ìŒì› ${musicId}ë²ˆ ê°€ì‚¬ ë‹¤ìš´ë¡œë“œ ìš”ì²­ ì‹œì‘`, 'request');
                    
                    const { response } = await makeActualRequest(endpoint, apiKey, serverUrl);

                    // ê°€ì‚¬ íŒŒì¼ ë‹¤ìš´ë¡œë“œ (Response ê°ì²´ í™•ì¸)
                    if (!response || typeof response.text !== 'function') {
                        throw new Error('ê°€ì‚¬ ì‘ë‹µ ê°ì²´ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                    }
                    const lyricsText = await response.text();
                    downloadFile(lyricsText, `lyrics_${musicId}.txt`, 'text/plain');
                    
                    showStatus(`ìŒì› ${musicId}ë²ˆ ê°€ì‚¬ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ`, 'success');
                    addLog(`ìŒì› ${musicId}ë²ˆ ê°€ì‚¬ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ`, 'response');
                    
                } else {
                    throw new Error('ì§€ì›í•˜ì§€ ì•ŠëŠ” ì—”ë“œí¬ì¸íŠ¸ í˜•ì‹ì…ë‹ˆë‹¤.');
                }

            } catch (error) {
                console.error('ìš”ì²­ ì‹¤íŒ¨:', error);
                
                if (error.message.includes('401') || error.message.includes('Unauthorized')) {
                    showStatus('ìœ íš¨í•˜ì§€ ì•Šì€ API í‚¤ì…ë‹ˆë‹¤.', 'error');
                } else if (error.message.includes('403') || error.message.includes('Forbidden')) {
                    showStatus('ì¬ìƒ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. êµ¬ë… ë“±ê¸‰ì„ í™•ì¸í•´ì£¼ì„¸ìš”.', 'error');
                } else if (error.message.includes('404') || error.message.includes('Not Found')) {
                    showStatus('ìš”ì²­í•œ ë¦¬ì†ŒìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                } else if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                    showStatus('ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.', 'error');
                } else {
                    showStatus(`ìš”ì²­ ì‹¤íŒ¨: ${error.message}`, 'error');
                }
                
                deactivateSpeaker();
            } finally {
                setLoading(false);
            }
        }

        // ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        actionButton.addEventListener('click', makeRequest);

        // ì—”í„° í‚¤ ì²˜ë¦¬
        document.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !actionButton.disabled) {
                makeRequest();
            }
        });

        // ì´ˆê¸°í™”
        updateButtonText();
        addLog('MPS API í…ŒìŠ¤íŠ¸ í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” ì™„ë£Œ', 'response');
    </script>
</body>
</html>